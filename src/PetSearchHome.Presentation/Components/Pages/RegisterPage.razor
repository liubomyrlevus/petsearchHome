@page "/register"
@inject PetSearchHome.ViewModels.RegisterViewModel ViewModel
@implements IDisposable

<PageTitle>Реєстрація</PageTitle>

<div class="page-container">
    <h3>Створити обліковий запис</h3>

    <div class="card">
        <div class="card-body">
            <EditForm Model="ViewModel" OnValidSubmit="HandleValidSubmitAsync">
                <DataAnnotationsValidator />

                <div class="form-group mb-3">
                    <label class="form-label">Тип користувача</label>
                    <InputSelect @bind-Value="ViewModel.SelectedUserType" class="form-select">
                        <option value="Individual">Приватна особа</option>
                        <option value="Shelter">Притулок</option>
                    </InputSelect>
                </div>

                <hr />

                <div class="form-group mb-2">
                    <label class="form-label">Email</label>
                    <InputText @bind-Value="ViewModel.Email" class="form-control" />
                    <ValidationMessage For="@(() => ViewModel.Email)" />
                </div>

                <div class="form-group mb-2">
                    <label class="form-label">Пароль</label>
                    <InputText @bind-Value="ViewModel.Password" type="password" class="form-control" />
                    <ValidationMessage For="@(() => ViewModel.Password)" />
                </div>

                <hr />

                @if (ViewModel.SelectedUserType == "Individual")
                {
                    <h5>Дані приватної особи</h5>
                    <div class="form-group mb-2">
                        <label class="form-label">Ім’я</label>
                        <InputText @bind-Value="ViewModel.FirstName" class="form-control" />
                    </div>
                    <div class="form-group mb-2">
                        <label class="form-label">Прізвище</label>
                        <InputText @bind-Value="ViewModel.LastName" class="form-control" />
                    </div>
                    <div class="form-group mb-2">
                        <label class="form-label">Телефон</label>
                        <InputText @bind-Value="ViewModel.Phone" class="form-control" />
                    </div>
                    <div class="form-group mb-2">
                        <label class="form-label">Місто</label>
                        <InputText @bind-Value="ViewModel.City" class="form-control" />
                    </div>
                    <div class="form-group mb-2">
                        <label class="form-label">Район</label>
                        <InputText @bind-Value="ViewModel.District" class="form-control" />
                    </div>
                }

                @if (ViewModel.SelectedUserType == "Shelter")
                {
                    <h5>Дані притулку</h5>
                    <div class="form-group mb-2">
                        <label class="form-label">Назва притулку</label>
                        <InputText @bind-Value="ViewModel.ShelterName" class="form-control" />
                    </div>
                    <div class="form-group mb-2">
                        <label class="form-label">Контактна особа</label>
                        <InputText @bind-Value="ViewModel.ContactPerson" class="form-control" />
                    </div>
                    <div class="form-group mb-2">
                        <label class="form-label">Телефон</label>
                        <InputText @bind-Value="ViewModel.ShelterPhone" class="form-control" />
                    </div>
                    <div class="form-group mb-2">
                        <label class="form-label">Адреса</label>
                        <InputText @bind-Value="ViewModel.Address" class="form-control" />
                    </div>
                }

                @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
                {
                    <div class="alert alert-danger mt-3">@ViewModel.ErrorMessage</div>
                }

                <button type="submit" class="btn btn-primary mt-3" disabled="@ViewModel.IsBusy">
                    @if (ViewModel.IsBusy)
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                        <span>Створення облікового запису...</span>
                    }
                    else
                    {
                        <span>Зареєструватися</span>
                    }
                </button>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private System.ComponentModel.PropertyChangedEventHandler? _propertyChangedHandler;

    private async Task HandleValidSubmitAsync()
    {
        await ViewModel.RegisterAsync();
        // Ensure a render after async work completes
        await InvokeAsync(StateHasChanged);
    }

    protected override void OnInitialized()
    {
        // Marshal state updates to the Dispatcher to avoid cross-thread rendering
        _propertyChangedHandler = async (_, __) => await InvokeAsync(StateHasChanged);
        ViewModel.PropertyChanged += _propertyChangedHandler;
    }

    public void Dispose()
    {
        if (_propertyChangedHandler != null)
        {
            ViewModel.PropertyChanged -= _propertyChangedHandler;
        }
    }
}

