@page "/edit-listing/{ListingId:int}"
@inject PetSearchHome.ViewModels.EditListingViewModel ViewModel
@implements IDisposable
@using PetSearchHome.DAL.Domain.Enums

<PageTitle>Редагування оголошення</PageTitle>

<div class="page-container">
    <h2>Редагувати оголошення</h2>

    @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
    {
        <div class="alert alert-danger">@ViewModel.ErrorMessage</div>
    }

    @if (ViewModel.IsBusy && ViewModel.ListingId == 0)
    {
        <p><em>Завантажуємо дані оголошення...</em></p>
    }
    else if (ViewModel.ListingId == 0)
    {
        <p><em>Оголошення не знайдено або недоступне для редагування.</em></p>
    }
    else
    {
        <EditForm class="create-listing-form"
                  Model="ViewModel"
                  OnValidSubmit="ViewModel.UpdateListingCommand.ExecuteAsync">
            <DataAnnotationsValidator />

            <div class="form-grid">
                <div class="form-section">
                    <h4>Основні дані</h4>

                    <div class="form-field">
                        <label>Тип тварини</label>
                        <InputSelect @bind-Value="ViewModel.AnimalType" class="form-select">
                            <option value="@AnimalType.unknown">Оберіть тип тварини...</option>
                            <option value="@AnimalType.dog">Собака</option>
                            <option value="@AnimalType.cat">Кіт / кішка</option>
                            <option value="@AnimalType.bird">Птах</option>
                            <option value="@AnimalType.rodent">Гризун</option>
                            <option value="@AnimalType.reptile">Рептилія</option>
                            <option value="@AnimalType.other">Інше</option>
                        </InputSelect>
                    </div>

                    <div class="form-field">
                        <label>Порода / назва</label>
                        <InputText @bind-Value="ViewModel.Breed" class="form-control" />
                    </div>

                    <div class="form-field">
                        <label>Вік (у місяцях)</label>
                        <InputNumber @bind-Value="ViewModel.AgeMonths" class="form-control" />
                    </div>

                    <div class="form-row">
                        <div class="form-field">
                            <label>Стать</label>
                            <InputSelect @bind-Value="ViewModel.Sex" class="form-select">
                                <option value="@AnimalSex.unknown">Не вказано</option>
                                <option value="@AnimalSex.male">Самець</option>
                                <option value="@AnimalSex.female">Самка</option>
                            </InputSelect>
                        </div>

                        <div class="form-field">
                            <label>Розмір</label>
                            <InputSelect @bind-Value="ViewModel.Size" class="form-select">
                                <option value="@AnimalSize.unknown">Не вказано</option>
                                <option value="@AnimalSize.small">Малий</option>
                                <option value="@AnimalSize.medium">Середній</option>
                                <option value="@AnimalSize.large">Великий</option>
                                <option value="@AnimalSize.giant">Дуже великий</option>
                            </InputSelect>
                        </div>
                    </div>

                    <div class="form-field">
                        <label>Колір</label>
                        <InputText @bind-Value="ViewModel.Color" class="form-control" />
                    </div>
                </div>

                <div class="form-section">
                    <h4>Локація та фото</h4>

                    <div class="form-field">
                        <label>Місто</label>
                        <InputText @bind-Value="ViewModel.City" class="form-control" />
                    </div>

                    <div class="form-field">
                        <label>Район</label>
                        <InputText @bind-Value="ViewModel.District" class="form-control" />
                    </div>

                    <div class="form-field">
                        <label>Головне фото (URL)</label>
                        <InputText @bind-Value="ViewModel.MainPhotoUrl" class="form-control" />
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h4>Опис</h4>

                <div class="form-field">
                    <label>Короткий опис</label>
                    <InputTextArea @bind-Value="ViewModel.Description" class="form-control" rows="4" />
                </div>

                <div class="form-field">
                    <label>Особливості або потреби</label>
                    <InputTextArea @bind-Value="ViewModel.SpecialNeeds" class="form-control" rows="3" />
                </div>
            </div>

            <div class="form-section">
                <h4>Медичні дані</h4>

                <div class="form-field">
                    <label>Щеплення</label>
                    <InputTextArea @bind-Value="ViewModel.Vaccinations" class="form-control" rows="2" />
                </div>

                <div class="form-field checkbox-field">
                    <label>
                        <InputCheckbox @bind-Value="ViewModel.Sterilized" />
                        Стерилізовано
                    </label>
                </div>

                <div class="form-field">
                    <label>Хронічні захворювання</label>
                    <InputTextArea @bind-Value="ViewModel.ChronicDiseases" class="form-control" rows="2" />
                </div>

                <div class="form-field">
                    <label>Історія лікування</label>
                    <InputTextArea @bind-Value="ViewModel.TreatmentHistory" class="form-control" rows="2" />
                </div>
            </div>

            <div class="actions">
                <button type="submit" class="btn btn-primary" disabled="@(!ViewModel.CanSubmit)">
                    @if (ViewModel.IsBusy)
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                        <span>Оновлюємо...</span>
                    }
                    else
                    {
                        <span>Зберегти зміни</span>
                    }
                </button>

                <NavLink class="btn btn-outline-secondary" href="/my-listings">
                    Повернутися
                </NavLink>
            </div>
        </EditForm>
    }
</div>

@code {
    [Parameter]
    public int ListingId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        ViewModel.PropertyChanged += OnViewModelPropertyChanged;

        if (ViewModel.LoadCommand.CanExecute(ListingId))
        {
            await ViewModel.LoadCommand.ExecuteAsync(ListingId);
        }
    }

    private void OnViewModelPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ViewModel.PropertyChanged -= OnViewModelPropertyChanged;
    }
}
