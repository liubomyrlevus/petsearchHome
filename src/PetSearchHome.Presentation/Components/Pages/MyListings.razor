@page "/my-listings"
@inject PetSearchHome.ViewModels.MyListingsViewModel ViewModel
@implements IDisposable
@using PetSearchHome.BLL.Domain.Enums

<PageTitle>Мої оголошення</PageTitle>

<div class="page-container">
    <h1>Мої оголошення</h1>

    @if (ViewModel.IsBusy)
    {
        <p><em>Завантажуємо список...</em></p>
    }
    else
    {
        if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
        {
            <div class="alert alert-danger">@ViewModel.ErrorMessage</div>
        }

        if (!string.IsNullOrEmpty(ViewModel.InfoMessage))
        {
            <div class="alert alert-success">@ViewModel.InfoMessage</div>
        }

        if (!ViewModel.Listings.Any())
        {
            <p class="text-muted"><em>Ви ще не створили жодного оголошення.</em></p>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th style="width: 120px;">Фото</th>
                            <th>Порода / кличка</th>
                            <th>Місто</th>
                            <th>Статус</th>
                            <th class="text-end">Дії</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var listing in ViewModel.Listings)
                        {
                            <tr>
                                <td>
                                    <img src="@(string.IsNullOrEmpty(listing.MainPhotoUrl) ? "/images/default-pet.png" : listing.MainPhotoUrl)"
                                         class="img-fluid rounded"
                                         alt="Фото оголошення"
                                         style="max-height: 80px;" />
                                </td>
                                <td>@(listing.Breed ?? "Без назви")</td>
                                <td>@listing.City</td>
                                <td>
                                    <span class="badge @ViewModel.GetStatusCss(listing.Status)">
                                        @ViewModel.GetStatusLabel(listing.Status)
                                    </span>
                                </td>
                                <td class="text-end">
                                    <a class="btn btn-outline-primary btn-sm me-2" href="/listing/@listing.Id">Переглянути</a>
                                    <button class="btn btn-outline-danger btn-sm"
                                            @onclick="() => ViewModel.DeleteListingCommand.ExecuteAsync(listing.Id)">
                                        Видалити
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    }
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        ViewModel.PropertyChanged += OnViewModelPropertyChanged;

        if (ViewModel.LoadListingsCommand.CanExecute(null))
        {
            await ViewModel.LoadListingsCommand.ExecuteAsync(null);
        }
    }

    private void OnViewModelPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ViewModel.PropertyChanged -= OnViewModelPropertyChanged;
    }
}
